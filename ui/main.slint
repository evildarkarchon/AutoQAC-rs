// Main Slint UI file for AutoQAC
//
// Complete Fluent Design implementation for the AutoQAC application.
// This provides a modern, Windows 11-style interface for batch cleaning
// Bethesda game plugins using xEdit.

import { FluentPalette, FluentTypography, FluentLayout } from "fluent/styles.slint";
import { FluentButton } from "fluent/button.slint";
import { FluentCard } from "fluent/card.slint";
import { FluentLineEdit } from "fluent/input.slint";
import { FluentCheckBox } from "fluent/checkbox.slint";
import { FluentDialog, FluentErrorDialog, FluentMessageDialog } from "fluent/dialog.slint";

export component MainWindow inherits Window {
    title: "AutoQAC - Automatic Quick Auto Clean";
    background: FluentPalette.background;
    preferred-width: 900px;
    preferred-height: 750px;
    min-width: 700px;
    min-height: 600px;

    // ========================================================================
    // Properties - Bound to Rust State
    // ========================================================================

    // Configuration paths
    in-out property <string> load-order-path: "";
    in-out property <string> xedit-exe-path: "";
    in-out property <string> mo2-exe-path: "";

    // Runtime state
    in-out property <bool> is-cleaning: false;
    in-out property <int> progress-current: 0;
    in-out property <int> progress-total: 0;
    in-out property <string> current-plugin: "";
    in-out property <string> current-operation: "";

    // Settings
    in-out property <bool> mo2-mode: false;
    in-out property <bool> partial-forms-enabled: false;

    // Results
    in-out property <int> cleaned-count: 0;
    in-out property <int> failed-count: 0;
    in-out property <int> skipped-count: 0;

    // Current plugin statistics (for progress display)
    in-out property <int> current-undeleted: 0;
    in-out property <int> current-removed: 0;
    in-out property <int> current-skipped: 0;
    in-out property <int> current-partial-forms: 0;
    in-out property <int> current-total-processed: 0;

    // Aggregate statistics across all plugins (for results summary)
    in-out property <int> total-undeleted: 0;
    in-out property <int> total-removed: 0;
    in-out property <int> total-skipped: 0;
    in-out property <int> total-partial-forms: 0;
    in-out property <int> total-records-processed: 0;

    // Dialog visibility
    in-out property <bool> show-partial-forms-warning: false;
    in-out property <bool> show-error-dialog: false;
    in-out property <bool> show-close-confirmation: false;
    in-out property <bool> show-message-dialog: false;

    // Error dialog content
    in-out property <string> error-title: "Error";
    in-out property <string> error-message: "";
    in-out property <string> error-details: "";

    // Message dialog content
    in-out property <string> message-title: "Information";
    in-out property <string> message-text: "";

    // ========================================================================
    // Callbacks - Handled by Rust GUI Controller
    // ========================================================================

    callback start-cleaning();
    callback stop-cleaning();
    callback browse-load-order();
    callback browse-xedit();
    callback browse-mo2();
    callback mo2-mode-toggled();
    callback partial-forms-toggled();
    callback partial-forms-warning-confirmed();
    callback partial-forms-warning-cancelled();
    callback error-dialog-dismissed();
    callback close-confirmation-proceed();
    callback close-confirmation-cancelled();
    callback message-dialog-dismissed();

    // ========================================================================
    // Main UI Layout
    // ========================================================================

    VerticalLayout {
        padding-left: FluentLayout.container-padding;
        padding-right: FluentLayout.container-padding;
        padding-top: FluentLayout.container-padding;
        padding-bottom: FluentLayout.container-padding;
        spacing: FluentLayout.section-spacing;

        // ====================================================================
        // Header Section
        // ====================================================================

        HorizontalLayout {
            spacing: FluentPalette.spacing-md;

            // App title
            VerticalLayout {
                alignment: start;
                horizontal-stretch: 1;

                Text {
                    text: "AutoQAC";
                    font-size: FluentTypography.title-large;
                    font-weight: FluentTypography.weight-bold;
                    color: FluentPalette.text-primary;
                }

                Text {
                    text: "Automatic Quick Auto Clean for Bethesda Game Plugins";
                    font-size: FluentTypography.body;
                    color: FluentPalette.text-secondary;
                }
            }

            // Version/status badge (optional)
            Rectangle {
                width: 60px;
                height: 24px;
                border-radius: 12px;
                background: FluentPalette.surface;
                border-width: FluentLayout.border-thin;
                border-color: FluentPalette.card-stroke;

                Text {
                    text: "v3.0";
                    font-size: FluentTypography.caption;
                    color: FluentPalette.text-secondary;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        // ====================================================================
        // Configuration Card
        // ====================================================================

        FluentCard {
            title: "Configuration";

            VerticalLayout {
                spacing: FluentPalette.spacing-md;

                // Load Order Path
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Load Order:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> load-order-path;
                        placeholder: "Path to plugins.txt";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-load-order(); }
                    }
                }

                // xEdit Executable Path
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "xEdit:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> xedit-exe-path;
                        placeholder: "Path to SSEEdit.exe / FO4Edit.exe";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-xedit(); }
                    }
                }

                // MO2 Path (conditional - only shown if MO2 mode is enabled)
                if mo2-mode: HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Mod Organizer 2:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> mo2-exe-path;
                        placeholder: "Path to ModOrganizer.exe";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-mo2(); }
                    }
                }
            }
        }

        // ====================================================================
        // Options Card
        // ====================================================================

        FluentCard {
            title: "Options";

            HorizontalLayout {
                spacing: FluentPalette.spacing-xl;

                FluentCheckBox {
                    text: "Use Mod Organizer 2";
                    checked <=> mo2-mode;
                    enabled: !is-cleaning;
                    toggled => { mo2-mode-toggled(); }
                }

                FluentCheckBox {
                    text: "Enable Partial Forms (Experimental)";
                    checked <=> partial-forms-enabled;
                    enabled: !is-cleaning;
                    toggled => { partial-forms-toggled(); }
                }
            }
        }

        // ====================================================================
        // Progress Card (only shown during cleaning)
        // ====================================================================

        if is-cleaning: FluentCard {
            title: "Cleaning Progress";

            VerticalLayout {
                spacing: FluentPalette.spacing-md;

                // Progress status text
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Progress:";
                        color: FluentPalette.text-secondary;
                        font-size: FluentTypography.body;
                    }

                    Text {
                        text: progress-current + " / " + progress-total;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                        font-weight: FluentTypography.weight-semibold;
                    }
                }

                // Progress bar
                Rectangle {
                    height: 6px;
                    background: FluentPalette.surface-secondary;
                    border-radius: 3px;

                    // Progress fill
                    Rectangle {
                        height: parent.height;
                        width: progress-total > 0 ? (parent.width * progress-current / progress-total) : 0px;
                        background: FluentPalette.accent;
                        border-radius: parent.border-radius;

                        animate width {
                            duration: 200ms;
                            easing: ease-out;
                        }
                    }
                }

                // Current plugin being processed
                if current-plugin != "": Text {
                    text: "Processing: " + current-plugin;
                    color: FluentPalette.text-secondary;
                    font-size: FluentTypography.caption;
                }

                // Current operation
                if current-operation != "": Text {
                    text: current-operation;
                    color: FluentPalette.text-tertiary;
                    font-size: FluentTypography.caption;
                }

                // Current plugin statistics (shown if any records processed)
                if current-total-processed > 0: VerticalLayout {
                    spacing: FluentPalette.spacing-sm;

                    // Divider
                    Rectangle {
                        height: 1px;
                        background: FluentPalette.card-stroke;
                    }

                    // Statistics header
                    Text {
                        text: "Current Plugin Statistics:";
                        color: FluentPalette.text-secondary;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                    }

                    // Statistics list
                    VerticalLayout {
                        spacing: 2px;

                        // UDRs (Undeleted References)
                        if current-undeleted > 0: HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "•";
                                color: FluentPalette.info;
                                font-size: FluentTypography.caption;
                            }
                            Text {
                                text: current-undeleted + " UDRs undeleted";
                                color: FluentPalette.text-secondary;
                                font-size: FluentTypography.caption;
                            }
                        }

                        // ITMs (Identical To Master)
                        if current-removed > 0: HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "•";
                                color: FluentPalette.success;
                                font-size: FluentTypography.caption;
                            }
                            Text {
                                text: current-removed + " ITMs removed";
                                color: FluentPalette.text-secondary;
                                font-size: FluentTypography.caption;
                            }
                        }

                        // Deleted Navmeshes
                        if current-skipped > 0: HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "•";
                                color: FluentPalette.warning;
                                font-size: FluentTypography.caption;
                            }
                            Text {
                                text: current-skipped + " deleted navmeshes";
                                color: FluentPalette.text-secondary;
                                font-size: FluentTypography.caption;
                            }
                        }

                        // Partial Forms (experimental)
                        if current-partial-forms > 0: HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "•";
                                color: FluentPalette.accent;
                                font-size: FluentTypography.caption;
                            }
                            Text {
                                text: current-partial-forms + " partial forms";
                                color: FluentPalette.text-secondary;
                                font-size: FluentTypography.caption;
                            }
                        }
                    }

                    // Total processed count
                    Text {
                        text: "Total: " + current-total-processed + " records processed";
                        color: FluentPalette.text-tertiary;
                        font-size: FluentTypography.caption;
                    }
                }
            }
        }

        // ====================================================================
        // Results Summary (shown after cleaning completes)
        // ====================================================================

        if !is-cleaning && (cleaned-count > 0 || failed-count > 0): FluentCard {
            title: "Summary";

            HorizontalLayout {
                spacing: FluentPalette.spacing-xl;

                // Cleaned count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.success;
                    }

                    Text {
                        text: "Cleaned: " + cleaned-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }

                // Failed count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.error;
                    }

                    Text {
                        text: "Failed: " + failed-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }

                // Skipped count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.warning;
                    }

                    Text {
                        text: "Skipped: " + skipped-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }
            }

            // Aggregate statistics (shown if any records were processed)
            if total-records-processed > 0: VerticalLayout {
                spacing: FluentPalette.spacing-sm;

                // Divider
                Rectangle {
                    height: 1px;
                    background: FluentPalette.card-stroke;
                }

                // Statistics header
                Text {
                    text: "Total Records Processed:";
                    color: FluentPalette.text-secondary;
                    font-size: FluentTypography.caption;
                    font-weight: FluentTypography.weight-semibold;
                }

                // Statistics list
                VerticalLayout {
                    spacing: 2px;

                    // UDRs (Undeleted References)
                    if total-undeleted > 0: HorizontalLayout {
                        spacing: 4px;
                        Text {
                            text: "•";
                            color: FluentPalette.info;
                            font-size: FluentTypography.caption;
                        }
                        Text {
                            text: total-undeleted + " UDRs undeleted";
                            color: FluentPalette.text-secondary;
                            font-size: FluentTypography.caption;
                        }
                    }

                    // ITMs (Identical To Master)
                    if total-removed > 0: HorizontalLayout {
                        spacing: 4px;
                        Text {
                            text: "•";
                            color: FluentPalette.success;
                            font-size: FluentTypography.caption;
                        }
                        Text {
                            text: total-removed + " ITMs removed";
                            color: FluentPalette.text-secondary;
                            font-size: FluentTypography.caption;
                        }
                    }

                    // Deleted Navmeshes
                    if total-skipped > 0: HorizontalLayout {
                        spacing: 4px;
                        Text {
                            text: "•";
                            color: FluentPalette.warning;
                            font-size: FluentTypography.caption;
                        }
                        Text {
                            text: total-skipped + " deleted navmeshes";
                            color: FluentPalette.text-secondary;
                            font-size: FluentTypography.caption;
                        }
                    }

                    // Partial Forms (experimental)
                    if total-partial-forms > 0: HorizontalLayout {
                        spacing: 4px;
                        Text {
                            text: "•";
                            color: FluentPalette.accent;
                            font-size: FluentTypography.caption;
                        }
                        Text {
                            text: total-partial-forms + " partial forms";
                            color: FluentPalette.text-secondary;
                            font-size: FluentTypography.caption;
                        }
                    }
                }

                // Total summary
                Text {
                    text: "Total: " + total-records-processed + " records processed";
                    color: FluentPalette.text-tertiary;
                    font-size: FluentTypography.caption;
                }
            }
        }

        // Spacer to push buttons to bottom
        Rectangle {
            vertical-stretch: 1;
        }

        // ====================================================================
        // Control Buttons (Bottom Section)
        // ====================================================================

        HorizontalLayout {
            spacing: FluentPalette.spacing-md;
            alignment: end;

            // Stop button (only enabled during cleaning)
            FluentButton {
                text: "Stop";
                enabled: is-cleaning;
                clicked => { stop-cleaning(); }
            }

            // Start/Cleaning button
            FluentButton {
                text: is-cleaning ? "Cleaning..." : "Start Cleaning";
                primary: true;
                enabled: !is-cleaning && load-order-path != "" && xedit-exe-path != "";
                clicked => {
                    if (!is-cleaning) {
                        start-cleaning();
                    }
                }
            }
        }
    }

    // ====================================================================
    // Partial Forms Warning Dialog
    // ====================================================================

    if show-partial-forms-warning: FluentDialog {
        dialog-title: "Partial Forms Warning";
        message: "⚠️  WARNING: Partial Forms Cleaning\n\n" +
                 "Enabling partial forms cleaning will clean plugins that contain " +
                 "partial forms (records that are split across multiple plugins).\n\n" +
                 "This can be dangerous and may break your game if not done carefully.\n\n" +
                 "Only enable this if you understand the risks and have a backup " +
                 "of your plugins.\n\n" +
                 "Do you want to enable partial forms cleaning?";
        show-cancel: true;
        confirm-text: "Enable Partial Forms";
        cancel-text: "Cancel";

        confirmed => {
            partial-forms-warning-confirmed();
        }

        cancelled => {
            partial-forms-warning-cancelled();
        }
    }

    // ====================================================================
    // Error Dialog
    // ====================================================================

    if show-error-dialog: FluentErrorDialog {
        dialog-title: error-title;
        message: error-message;
        error-details: error-details;

        confirmed => {
            error-dialog-dismissed();
        }
    }

    // ====================================================================
    // Close Confirmation Dialog
    // ====================================================================
    // Shown when user tries to close window during cleaning operation.
    // Uses Slint's window().on_close_requested() API to intercept close.

    if show-close-confirmation: FluentDialog {
        dialog-title: "Confirm Exit";
        message: "Cleaning is currently in progress.\n\n" +
                 "If you exit now, the current operation will be cancelled.\n\n" +
                 "Are you sure you want to exit?";
        show-cancel: true;
        confirm-text: "Exit";
        cancel-text: "Continue Cleaning";

        confirmed => {
            close-confirmation-proceed();
        }

        cancelled => {
            close-confirmation-cancelled();
        }
    }

    // ====================================================================
    // Information/Message Dialog
    // ====================================================================

    if show-message-dialog: FluentMessageDialog {
        dialog-title: message-title;
        message: message-text;

        confirmed => {
            message-dialog-dismissed();
        }
    }
}
