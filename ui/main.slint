// Main Slint UI file for AutoQAC
//
// Complete Fluent Design implementation for the AutoQAC application.
// This provides a modern, Windows 11-style interface for batch cleaning
// Bethesda game plugins using xEdit.

import { FluentPalette, FluentTypography, FluentLayout } from "fluent/styles.slint";
import { FluentButton } from "fluent/button.slint";
import { FluentCard } from "fluent/card.slint";
import { FluentLineEdit } from "fluent/input.slint";
import { FluentCheckBox } from "fluent/checkbox.slint";
import { FluentDialog, FluentErrorDialog, FluentMessageDialog } from "fluent/dialog.slint";

export component MainWindow inherits Window {
    title: "AutoQAC - Automatic Quick Auto Clean";
    background: FluentPalette.background;
    preferred-width: 900px;
    preferred-height: 750px;
    min-width: 700px;
    min-height: 600px;

    // ========================================================================
    // Properties - Bound to Rust State
    // ========================================================================

    // Configuration paths
    in-out property <string> load-order-path: "";
    in-out property <string> xedit-exe-path: "";
    in-out property <string> mo2-exe-path: "";

    // Runtime state
    in-out property <bool> is-cleaning: false;
    in-out property <int> progress-current: 0;
    in-out property <int> progress-total: 0;
    in-out property <string> current-plugin: "";
    in-out property <string> current-operation: "";

    // Settings
    in-out property <bool> mo2-mode: false;
    in-out property <bool> partial-forms-enabled: false;

    // Results
    in-out property <int> cleaned-count: 0;
    in-out property <int> failed-count: 0;
    in-out property <int> skipped-count: 0;

    // Current plugin statistics (for progress display)
    in-out property <int> current-undeleted: 0;
    in-out property <int> current-removed: 0;
    in-out property <int> current-skipped: 0;
    in-out property <int> current-partial-forms: 0;
    in-out property <int> current-total-processed: 0;

    // Aggregate statistics across all plugins (for results summary)
    in-out property <int> total-undeleted: 0;
    in-out property <int> total-removed: 0;
    in-out property <int> total-skipped: 0;
    in-out property <int> total-partial-forms: 0;
    in-out property <int> total-records-processed: 0;

    // Path validation state
    in-out property <bool> load-order-path-valid: false;
    in-out property <bool> xedit-exe-path-valid: false;
    in-out property <bool> mo2-exe-path-valid: false;
    in-out property <string> detected-game-type: "";

    // Configuration status
    in-out property <string> status-message: "Ready";
    in-out property <bool> is-fully-configured: false;
    in-out property <int> total-plugins-in-load-order: 0;

    // Dialog visibility
    in-out property <bool> show-partial-forms-warning: false;
    in-out property <bool> show-error-dialog: false;
    in-out property <bool> show-close-confirmation: false;
    in-out property <bool> show-message-dialog: false;
    in-out property <bool> show-about-dialog: false;

    // Error dialog content
    in-out property <string> error-title: "Error";
    in-out property <string> error-message: "";
    in-out property <string> error-details: "";

    // Message dialog content
    in-out property <string> message-title: "Information";
    in-out property <string> message-text: "";

    // ========================================================================
    // Callbacks - Handled by Rust GUI Controller
    // ========================================================================

    callback start-cleaning();
    callback stop-cleaning();
    callback refresh-configuration();
    callback browse-load-order();
    callback browse-xedit();
    callback browse-mo2();
    callback mo2-mode-toggled();
    callback partial-forms-toggled();
    callback partial-forms-warning-confirmed();
    callback partial-forms-warning-cancelled();
    callback error-dialog-dismissed();
    callback close-confirmation-proceed();
    callback close-confirmation-cancelled();
    callback message-dialog-dismissed();
    callback show-about();
    callback about-dialog-dismissed();

    // ========================================================================
    // Main UI Layout
    // ========================================================================

    VerticalLayout {
        padding-left: FluentLayout.container-padding;
        padding-right: FluentLayout.container-padding;
        padding-top: FluentLayout.container-padding;
        padding-bottom: FluentLayout.container-padding;
        spacing: FluentLayout.section-spacing;

        // ====================================================================
        // Header Section
        // ====================================================================

        HorizontalLayout {
            spacing: FluentPalette.spacing-md;

            // App title
            VerticalLayout {
                alignment: start;
                horizontal-stretch: 1;

                Text {
                    text: "AutoQAC";
                    font-size: FluentTypography.title-large;
                    font-weight: FluentTypography.weight-bold;
                    color: FluentPalette.text-primary;
                }

                Text {
                    text: "Automatic Quick Auto Clean for Bethesda Game Plugins";
                    font-size: FluentTypography.body;
                    color: FluentPalette.text-secondary;
                }
            }

            // About button
            FluentButton {
                text: "About";
                max-width: 80px;
                clicked => { show-about(); }
            }

            // Configuration status badge
            Rectangle {
                min-width: 120px;
                height: 28px;
                border-radius: 14px;
                background: is-fully-configured ? #1A4D2E : #4A3800;
                border-width: 1px;
                border-color: is-fully-configured ? FluentPalette.success : FluentPalette.warning;

                HorizontalLayout {
                    padding: 4px;
                    spacing: 6px;

                    Text {
                        text: is-fully-configured ? "✓" : "⚠";
                        font-size: 14px;
                        color: is-fully-configured ? FluentPalette.success : FluentPalette.warning;
                        vertical-alignment: center;
                    }

                    Text {
                        text: is-fully-configured ? "Ready" : "Setup Required";
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                        color: is-fully-configured ? FluentPalette.success : FluentPalette.warning;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // ====================================================================
        // Configuration Card
        // ====================================================================

        FluentCard {
            title: "Configuration";

            VerticalLayout {
                spacing: FluentPalette.spacing-md;

                // Load Order Path
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Load Order:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> load-order-path;
                        placeholder: "Path to plugins.txt";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    // Validation indicator
                    if load-order-path != "": Rectangle {
                        width: 20px;
                        height: 20px;

                        Text {
                            text: load-order-path-valid ? "✓" : "✗";
                            color: load-order-path-valid ? FluentPalette.success : FluentPalette.error;
                            font-size: 14px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-load-order(); }
                    }
                }

                // xEdit Executable Path
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "xEdit:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> xedit-exe-path;
                        placeholder: "Path to SSEEdit.exe / FO4Edit.exe";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    // Validation indicator
                    if xedit-exe-path != "": Rectangle {
                        width: 20px;
                        height: 20px;

                        Text {
                            text: xedit-exe-path-valid ? "✓" : "✗";
                            color: xedit-exe-path-valid ? FluentPalette.success : FluentPalette.error;
                            font-size: 14px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Game type indicator
                    if detected-game-type != "": Text {
                        text: "(" + detected-game-type + ")";
                        color: FluentPalette.text-tertiary;
                        font-size: FluentTypography.caption;
                        vertical-alignment: center;
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-xedit(); }
                    }
                }

                // MO2 Path (conditional - only shown if MO2 mode is enabled)
                if mo2-mode: HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Mod Organizer 2:";
                        vertical-alignment: center;
                        min-width: 120px;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }

                    FluentLineEdit {
                        text <=> mo2-exe-path;
                        placeholder: "Path to ModOrganizer.exe";
                        enabled: !is-cleaning;
                        horizontal-stretch: 1;
                    }

                    // Validation indicator
                    if mo2-exe-path != "": Rectangle {
                        width: 20px;
                        height: 20px;

                        Text {
                            text: mo2-exe-path-valid ? "✓" : "✗";
                            color: mo2-exe-path-valid ? FluentPalette.success : FluentPalette.error;
                            font-size: 14px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    FluentButton {
                        text: "Browse";
                        enabled: !is-cleaning;
                        max-width: 100px;
                        clicked => { browse-mo2(); }
                    }
                }

                // Refresh Configuration button
                HorizontalLayout {
                    alignment: end;

                    FluentButton {
                        text: "Refresh Configuration";
                        enabled: !is-cleaning;
                        max-width: 180px;
                        clicked => { refresh-configuration(); }
                    }
                }
            }
        }

        // ====================================================================
        // Options Card
        // ====================================================================

        FluentCard {
            title: "Options";

            HorizontalLayout {
                spacing: FluentPalette.spacing-xl;

                FluentCheckBox {
                    text: "Use Mod Organizer 2";
                    checked <=> mo2-mode;
                    enabled: !is-cleaning;
                    toggled => { mo2-mode-toggled(); }
                }

                FluentCheckBox {
                    text: "Enable Partial Forms (Experimental)";
                    checked <=> partial-forms-enabled;
                    enabled: !is-cleaning;
                    toggled => { partial-forms-toggled(); }
                }
            }
        }

        // ====================================================================
        // Progress Card (only shown during cleaning)
        // ====================================================================

        if is-cleaning: FluentCard {
            title: "Cleaning Progress";

            VerticalLayout {
                spacing: FluentPalette.spacing-md;

                // Progress status text with percentage
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Text {
                        text: "Progress:";
                        color: FluentPalette.text-secondary;
                        font-size: FluentTypography.body;
                    }

                    Text {
                        text: progress-current + " / " + progress-total;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                        font-weight: FluentTypography.weight-semibold;
                    }

                    // Percentage indicator
                    if progress-total > 0: Text {
                        text: "(" + Math.round(progress-current * 100.0 / progress-total) + "%)";
                        color: FluentPalette.accent;
                        font-size: FluentTypography.body;
                        font-weight: FluentTypography.weight-semibold;
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    // Processing indicator
                    Text {
                        text: "⚙";
                        color: FluentPalette.accent;
                        font-size: 16px;
                    }
                }

                // Enhanced progress bar with percentage overlay
                Rectangle {
                    height: 24px;
                    background: FluentPalette.surface-secondary;
                    border-radius: 12px;
                    border-width: 1px;
                    border-color: FluentPalette.card-stroke;

                    // Progress fill
                    Rectangle {
                        height: parent.height - 2px;
                        width: progress-total > 0 ? ((parent.width - 2px) * progress-current / progress-total) : 0px;
                        x: 1px;
                        y: 1px;
                        background: FluentPalette.accent;
                        border-radius: parent.border-radius - 1px;

                        animate width {
                            duration: 300ms;
                            easing: ease-out;
                        }
                    }

                    // Percentage text overlay
                    if progress-total > 0: Text {
                        text: Math.round(progress-current * 100.0 / progress-total) + "%";
                        color: progress-current > progress-total / 2 ? #FFFFFF : FluentPalette.text-primary;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Current plugin being processed
                if current-plugin != "": Text {
                    text: "Processing: " + current-plugin;
                    color: FluentPalette.text-secondary;
                    font-size: FluentTypography.caption;
                }

                // Current operation
                if current-operation != "": Text {
                    text: current-operation;
                    color: FluentPalette.text-tertiary;
                    font-size: FluentTypography.caption;
                }

                // Current plugin statistics (shown if any records processed)
                if current-total-processed > 0: VerticalLayout {
                    spacing: FluentPalette.spacing-md;

                    // Divider
                    Rectangle {
                        height: 1px;
                        background: FluentPalette.card-stroke;
                    }

                    // Statistics header
                    Text {
                        text: "Current Plugin Statistics:";
                        color: FluentPalette.text-secondary;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                    }

                    // Statistics badges in horizontal layout
                    HorizontalLayout {
                        spacing: FluentPalette.spacing-sm;
                        alignment: start;

                        // UDRs badge (Undeleted References)
                        if current-undeleted > 0: Rectangle {
                            height: 28px;
                            border-radius: 14px;
                            background: #E3F2FD;
                            border-width: 1px;
                            border-color: FluentPalette.info;

                            HorizontalLayout {
                                padding: 8px;
                                spacing: 6px;

                                Rectangle {
                                    width: 6px;
                                    height: 6px;
                                    border-radius: 3px;
                                    background: FluentPalette.info;
                                    y: (parent.height - self.height) / 2;
                                }

                                Text {
                                    text: current-undeleted + " UDRs";
                                    color: #1976D2;
                                    font-size: FluentTypography.caption;
                                    font-weight: FluentTypography.weight-semibold;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // ITMs badge (Identical To Master)
                        if current-removed > 0: Rectangle {
                            height: 28px;
                            border-radius: 14px;
                            background: #E8F5E9;
                            border-width: 1px;
                            border-color: FluentPalette.success;

                            HorizontalLayout {
                                padding: 8px;
                                spacing: 6px;

                                Rectangle {
                                    width: 6px;
                                    height: 6px;
                                    border-radius: 3px;
                                    background: FluentPalette.success;
                                    y: (parent.height - self.height) / 2;
                                }

                                Text {
                                    text: current-removed + " ITMs";
                                    color: #388E3C;
                                    font-size: FluentTypography.caption;
                                    font-weight: FluentTypography.weight-semibold;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // Deleted Navmeshes badge
                        if current-skipped > 0: Rectangle {
                            height: 28px;
                            border-radius: 14px;
                            background: #FFF8E1;
                            border-width: 1px;
                            border-color: FluentPalette.warning;

                            HorizontalLayout {
                                padding: 8px;
                                spacing: 6px;

                                Rectangle {
                                    width: 6px;
                                    height: 6px;
                                    border-radius: 3px;
                                    background: FluentPalette.warning;
                                    y: (parent.height - self.height) / 2;
                                }

                                Text {
                                    text: current-skipped + " Navmeshes";
                                    color: #F57C00;
                                    font-size: FluentTypography.caption;
                                    font-weight: FluentTypography.weight-semibold;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // Partial Forms badge (experimental)
                        if current-partial-forms > 0: Rectangle {
                            height: 28px;
                            border-radius: 14px;
                            background: #F3E5F5;
                            border-width: 1px;
                            border-color: FluentPalette.accent;

                            HorizontalLayout {
                                padding: 8px;
                                spacing: 6px;

                                Rectangle {
                                    width: 6px;
                                    height: 6px;
                                    border-radius: 3px;
                                    background: FluentPalette.accent;
                                    y: (parent.height - self.height) / 2;
                                }

                                Text {
                                    text: current-partial-forms + " Partial";
                                    color: #7B1FA2;
                                    font-size: FluentTypography.caption;
                                    font-weight: FluentTypography.weight-semibold;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }

                    // Total processed count with visual badge
                    Rectangle {
                        height: 32px;
                        border-radius: 4px;
                        background: FluentPalette.surface-secondary;
                        border-width: 1px;
                        border-color: FluentPalette.card-stroke;

                        HorizontalLayout {
                            padding: 8px;
                            spacing: 8px;

                            Text {
                                text: "Total Records:";
                                color: FluentPalette.text-secondary;
                                font-size: FluentTypography.caption;
                                vertical-alignment: center;
                            }

                            Text {
                                text: current-total-processed;
                                color: FluentPalette.text-primary;
                                font-size: FluentTypography.caption;
                                font-weight: FluentTypography.weight-bold;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Results Summary (shown after cleaning completes)
        // ====================================================================

        if !is-cleaning && (cleaned-count > 0 || failed-count > 0): FluentCard {
            title: "Summary";

            HorizontalLayout {
                spacing: FluentPalette.spacing-xl;

                // Cleaned count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.success;
                    }

                    Text {
                        text: "Cleaned: " + cleaned-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }

                // Failed count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.error;
                    }

                    Text {
                        text: "Failed: " + failed-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }

                // Skipped count
                HorizontalLayout {
                    spacing: FluentPalette.spacing-sm;

                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: FluentPalette.warning;
                    }

                    Text {
                        text: "Skipped: " + skipped-count;
                        color: FluentPalette.text-primary;
                        font-size: FluentTypography.body;
                    }
                }
            }

            // Aggregate statistics (shown if any records were processed)
            if total-records-processed > 0: VerticalLayout {
                spacing: FluentPalette.spacing-md;

                // Divider
                Rectangle {
                    height: 1px;
                    background: FluentPalette.card-stroke;
                }

                // Statistics header
                Text {
                    text: "Total Records Processed:";
                    color: FluentPalette.text-secondary;
                    font-size: FluentTypography.caption;
                    font-weight: FluentTypography.weight-semibold;
                }

                // Statistics badges grid
                VerticalLayout {
                    spacing: FluentPalette.spacing-sm;

                    // First row: UDRs and ITMs
                    HorizontalLayout {
                        spacing: FluentPalette.spacing-sm;
                        alignment: start;

                        // UDRs badge
                        if total-undeleted > 0: Rectangle {
                            height: 36px;
                            min-width: 140px;
                            border-radius: 6px;
                            background: #E3F2FD;
                            border-width: 1px;
                            border-color: FluentPalette.info;

                            HorizontalLayout {
                                padding: 10px;
                                spacing: 8px;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: FluentPalette.info;
                                    y: (parent.height - self.height) / 2;
                                }

                                VerticalLayout {
                                    Text {
                                        text: total-undeleted;
                                        color: #1976D2;
                                        font-size: FluentTypography.body;
                                        font-weight: FluentTypography.weight-bold;
                                    }
                                    Text {
                                        text: "UDRs Undeleted";
                                        color: #1976D2;
                                        font-size: 10px;
                                    }
                                }
                            }
                        }

                        // ITMs badge
                        if total-removed > 0: Rectangle {
                            height: 36px;
                            min-width: 140px;
                            border-radius: 6px;
                            background: #E8F5E9;
                            border-width: 1px;
                            border-color: FluentPalette.success;

                            HorizontalLayout {
                                padding: 10px;
                                spacing: 8px;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: FluentPalette.success;
                                    y: (parent.height - self.height) / 2;
                                }

                                VerticalLayout {
                                    Text {
                                        text: total-removed;
                                        color: #388E3C;
                                        font-size: FluentTypography.body;
                                        font-weight: FluentTypography.weight-bold;
                                    }
                                    Text {
                                        text: "ITMs Removed";
                                        color: #388E3C;
                                        font-size: 10px;
                                    }
                                }
                            }
                        }
                    }

                    // Second row: Navmeshes and Partial Forms
                    HorizontalLayout {
                        spacing: FluentPalette.spacing-sm;
                        alignment: start;

                        // Navmeshes badge
                        if total-skipped > 0: Rectangle {
                            height: 36px;
                            min-width: 140px;
                            border-radius: 6px;
                            background: #FFF8E1;
                            border-width: 1px;
                            border-color: FluentPalette.warning;

                            HorizontalLayout {
                                padding: 10px;
                                spacing: 8px;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: FluentPalette.warning;
                                    y: (parent.height - self.height) / 2;
                                }

                                VerticalLayout {
                                    Text {
                                        text: total-skipped;
                                        color: #F57C00;
                                        font-size: FluentTypography.body;
                                        font-weight: FluentTypography.weight-bold;
                                    }
                                    Text {
                                        text: "Deleted Navmeshes";
                                        color: #F57C00;
                                        font-size: 10px;
                                    }
                                }
                            }
                        }

                        // Partial Forms badge
                        if total-partial-forms > 0: Rectangle {
                            height: 36px;
                            min-width: 140px;
                            border-radius: 6px;
                            background: #F3E5F5;
                            border-width: 1px;
                            border-color: FluentPalette.accent;

                            HorizontalLayout {
                                padding: 10px;
                                spacing: 8px;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: FluentPalette.accent;
                                    y: (parent.height - self.height) / 2;
                                }

                                VerticalLayout {
                                    Text {
                                        text: total-partial-forms;
                                        color: #7B1FA2;
                                        font-size: FluentTypography.body;
                                        font-weight: FluentTypography.weight-bold;
                                    }
                                    Text {
                                        text: "Partial Forms";
                                        color: #7B1FA2;
                                        font-size: 10px;
                                    }
                                }
                            }
                        }
                    }
                }

                // Total summary
                Text {
                    text: "Total: " + total-records-processed + " records processed";
                    color: FluentPalette.text-tertiary;
                    font-size: FluentTypography.caption;
                }
            }
        }

        // Spacer to push buttons to bottom
        Rectangle {
            vertical-stretch: 1;
        }

        // ====================================================================
        // Control Buttons (Bottom Section)
        // ====================================================================

        HorizontalLayout {
            spacing: FluentPalette.spacing-md;
            alignment: end;

            // Stop button (only enabled during cleaning)
            FluentButton {
                text: "Stop";
                enabled: is-cleaning;
                clicked => { stop-cleaning(); }
            }

            // Start/Cleaning button
            FluentButton {
                text: is-cleaning ? "Cleaning..." : "Start Cleaning";
                primary: true;
                enabled: !is-cleaning && load-order-path != "" && xedit-exe-path != "";
                clicked => {
                    if (!is-cleaning) {
                        start-cleaning();
                    }
                }
            }
        }

        // ====================================================================
        // Status Bar
        // ====================================================================

        Rectangle {
            height: 32px;
            background: FluentPalette.surface;
            border-width: 1px;
            border-color: FluentPalette.card-stroke;
            border-radius: FluentPalette.corner-radius;

            HorizontalLayout {
                padding: 8px;
                spacing: FluentPalette.spacing-md;

                // Status icon
                Text {
                    text: is-cleaning ? "⚙" : (is-fully-configured ? "✓" : "○");
                    font-size: 14px;
                    color: is-cleaning ? FluentPalette.accent : (is-fully-configured ? FluentPalette.success : FluentPalette.text-tertiary);
                    vertical-alignment: center;
                }

                // Status message
                Text {
                    text: status-message;
                    font-size: FluentTypography.caption;
                    color: is-cleaning ? FluentPalette.accent : FluentPalette.text-secondary;
                    font-weight: is-cleaning ? FluentTypography.weight-semibold : FluentTypography.weight-regular;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }

                // Plugin count indicator (when not cleaning)
                if !is-cleaning && total-plugins-in-load-order > 0: HorizontalLayout {
                    spacing: 4px;

                    Text {
                        text: "Plugins:";
                        font-size: FluentTypography.caption;
                        color: FluentPalette.text-tertiary;
                        vertical-alignment: center;
                    }

                    Text {
                        text: total-plugins-in-load-order;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                        color: FluentPalette.text-primary;
                        vertical-alignment: center;
                    }
                }

                // Progress indicator (when cleaning)
                if is-cleaning && progress-total > 0: HorizontalLayout {
                    spacing: 4px;

                    Text {
                        text: "Progress:";
                        font-size: FluentTypography.caption;
                        color: FluentPalette.text-tertiary;
                        vertical-alignment: center;
                    }

                    Text {
                        text: progress-current + "/" + progress-total;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                        color: FluentPalette.accent;
                        vertical-alignment: center;
                    }
                }

                // Game type indicator (if detected)
                if detected-game-type != "": HorizontalLayout {
                    spacing: 4px;

                    Text {
                        text: "Game:";
                        font-size: FluentTypography.caption;
                        color: FluentPalette.text-tertiary;
                        vertical-alignment: center;
                    }

                    Text {
                        text: detected-game-type;
                        font-size: FluentTypography.caption;
                        font-weight: FluentTypography.weight-semibold;
                        color: FluentPalette.accent;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }

    // ====================================================================
    // Partial Forms Warning Dialog
    // ====================================================================

    if show-partial-forms-warning: FluentDialog {
        dialog-title: "Partial Forms Warning";
        message: "⚠️  WARNING: Partial Forms Cleaning\n\n" +
                 "Enabling partial forms cleaning will clean plugins that contain " +
                 "partial forms (records that are split across multiple plugins).\n\n" +
                 "This can be dangerous and may break your game if not done carefully.\n\n" +
                 "Only enable this if you understand the risks and have a backup " +
                 "of your plugins.\n\n" +
                 "Do you want to enable partial forms cleaning?";
        show-cancel: true;
        confirm-text: "Enable Partial Forms";
        cancel-text: "Cancel";

        confirmed => {
            partial-forms-warning-confirmed();
        }

        cancelled => {
            partial-forms-warning-cancelled();
        }
    }

    // ====================================================================
    // Error Dialog
    // ====================================================================

    if show-error-dialog: FluentErrorDialog {
        dialog-title: error-title;
        message: error-message;
        error-details: error-details;

        confirmed => {
            error-dialog-dismissed();
        }
    }

    // ====================================================================
    // Close Confirmation Dialog
    // ====================================================================
    // Shown when user tries to close window during cleaning operation.
    // Uses Slint's window().on_close_requested() API to intercept close.

    if show-close-confirmation: FluentDialog {
        dialog-title: "Confirm Exit";
        message: "Cleaning is currently in progress.\n\n" +
                 "If you exit now, the current operation will be cancelled.\n\n" +
                 "Are you sure you want to exit?";
        show-cancel: true;
        confirm-text: "Exit";
        cancel-text: "Continue Cleaning";

        confirmed => {
            close-confirmation-proceed();
        }

        cancelled => {
            close-confirmation-cancelled();
        }
    }

    // ====================================================================
    // Information/Message Dialog
    // ====================================================================

    if show-message-dialog: FluentMessageDialog {
        dialog-title: message-title;
        message: message-text;

        confirmed => {
            message-dialog-dismissed();
        }
    }

    // ====================================================================
    // About Dialog
    // ====================================================================

    if show-about-dialog: FluentMessageDialog {
        dialog-title: "About AutoQAC";
        message: "AutoQAC - Automatic Quick Auto Clean\n" +
                 "Version 3.0.0\n\n" +
                 "A modern application for batch cleaning Bethesda game plugins using xEdit's Quick Auto Clean (-QAC) functionality.\n\n" +
                 "Removes Identical To Master (ITM) records, Undisabled References (UDRs), and deleted navmeshes from plugins for Fallout 3/NV/4 and Skyrim SE.\n\n" +
                 "Built with Rust 2024, Slint 1.13, and Tokio async runtime.\n\n" +
                 "Part of the XEdit-PACT Project\n" +
                 "© 2025 - MIT License";

        confirmed => {
            about-dialog-dismissed();
        }
    }
}
